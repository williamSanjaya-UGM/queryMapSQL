DROP TABLE TREE_TABLE;
DROP SEQUENCE TREE_TABLE_SEQ;

CREATE TABLE TREE_TABLE(
    TREE_ID NUMERIC NOT NULL PRIMARY KEY,
    NAME VARCHAR2(50),
    PARENT_TO VARCHAR2(50),
    CODE_FLAG NUMERIC,
    FLAG_BY NUMERIC,
    LVL_NAME VARCHAR2(20),
    TYPE_USAGE VARCHAR2(20)
);

CREATE SEQUENCE TREE_TABLE_SEQ
START WITH 1
INCREMENT BY 1
MAXVALUE 999
CYCLE;

ALTER TABLE TREE_TABLE MODIFY(TREE_ID DEFAULT TREE_TABLE_SEQ.NEXTVAL);

CREATE TABLE TREE_DESC(
    TREE_DESC_ID NUMERIC NOT NULL PRIMARY KEY,
    PARAM_CONDITION VARCHAR2(60),
    CATEGORY VARCHAR2(20) NOT NULL,
    TREE_ID NUMERIC NOT NULL,
    CONSTRAINT 
        FK_SUBFUNCTION_ID FOREIGN KEY(TREE_ID)
        REFERENCES TREE_TABLE (TREE_ID)
--    CONSTRAINT
--        PARAM_INDICATE_UNIQUE UNIQUE (PARAM_CONDITION,APP_ID)
);

CREATE SEQUENCE TREE_DESC_SEQ
START WITH 1
INCREMENT BY 1
MAXVALUE 999
CYCLE;

ALTER TABLE TREE_DESC MODIFY(TREE_DESC_ID DEFAULT TREE_DESC_SEQ.NEXTVAL);

-- SAMPLE APP
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('OKEFIT',NULL,1,NULL,'APP',NULL);
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SALESMAN',NULL,2,NULL,'APP',NULL);

-- SAMPLE MODULE
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SM SEHAT','OKEFIT',1,1,'MODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SM REPORT FIT','OKEFIT',2,1,'MODULE','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SM SALES','SALESMAN',3,2,'MODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SM REPORT SALES','SALESMAN',4,2,'MODULE','DATA');

-- SAMPLE SUBMODULE
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('WEB SEHAT FRONT','SM SEHAT',1,1,'SUBMODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('WEB SEHAT BACK','SM SEHAT',2,1,'SUBMODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('REPORT FIT','SM REPORT FIT',3,2,'SUBMODULE','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('REPORT RAW FIT','SM REPORT FIT',4,2,'SUBMODULE','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('WEB SALES FRONT','SM SALES',5,3,'SUBMODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('WEB SALES BACK','SM REPORT SALES',6,3,'SUBMODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('REPORT SALES','SM REPORT SALES',7,4,'SUBMODULE','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('REPORT RAW SALES','SM REPORT SALES',8,4,'SUBMODULE','DATA');

--SAMPLE FUNCTION
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('QUESTIONNAIRE KARYAWAN','WEB SEHAT FRONT',1,1,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RESULT ASSESMENT KARYAWAN','WEB SEHAT FRONT',2,1,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('QUESTIONNAIRE NON KARYAWAN','WEB SEHAT BACK',3,2,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RESULT ASSESMENT NON KARYAWAN','WEB SEHAT BACK',4,2,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD FIT','REPORT FIT',5,3,'FUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD RAW FIT','REPORT RAW FIT',6,4,'FUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('ROUTE SALES','WEB SALES FRONT',7,5,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('LOCATION SALES','WEB SALES FRONT',8,5,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('ROUTE NON SALES','WEB SALES BACK',9,6,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('LOCATION NON SALES','WEB SALES BACK',10,6,'FUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD SALES','REPORT SALES','FUNCTION',11,7,'DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD RAW SALES','REPORT RAW SALES',12,8,'FUNCTION','DATA');

--SAMPLE SUBFUNCTION APP1
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('VIEW QUESTIONNAIRE','QUESTIONNAIRE KARYAWAN',1,1,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('DO QUESTIONNAIRE','QUESTIONNAIRE KARYAWAN',2,1,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SUBMIT QUESTIONNAIRE','QUESTIONNAIRE KARYAWAN',3,1,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SHOW RESULT','RESULT ASSESMENT KARYAWAN',4,2,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('PRINT RESULT','RESULT ASSESMENT KARYAWAN',5,2,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('VIEW QUESTIONNAIRE','QUESTIONNAIRE NON KARYAWAN',6,3,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('DO QUESTIONNAIRE','QUESTIONNAIRE NON KARYAWAN',7,3,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SUBMIT QUESTIONNAIRE','QUESTIONNAIRE NON KARYAWAN',8,3,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SHOW RESULT','RESULT ASSESMENT NON KARYAWAN',9,4,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('PRINT RESULT','RESULT ASSESMENT NON KARYAWAN',10,4,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD BYTYPE','RECORD FIT',11,5,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD BYCATEGORY','RECORD FIT',12,5,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD FINAL','RECORD FIT',13,5,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD RAW BYTYPE','RECORD RAW FIT',14,6,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD RAW BYCATEGORY','RECORD RAW FIT',15,6,'SUBFUNCTION','DATA');

-- SAMPLE SUBFUNCTION APP2
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SHOW DONE','ROUTE SALES',16,7,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('MARK DONE','ROUTE SALES',17,7,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SAVE DONE','ROUTE SALES',18,7,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('NEAREST LOCATION','LOCATION SALES',19,8,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('FURTHEST LOCATION','LOCATION SALES',20,8,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('MARKUP LOCATION','LOCATION SALES',21,8,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SHOW DONE','ROUTE NON SALES',22,9,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('MARK DONE','ROUTE NON SALES',23,9,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SAVE DONE','ROUTE NON SALES',24,9,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('NEAREST LOCATION','LOCATION NON SALES',25,10,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('FURTHEST LOCATION','LOCATION NON SALES',26,10,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('MARKUP LOCATION','LOCATION SALES',27,8,'SUBFUNCTION','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD BYTYPE','RECORD SALES',28,11,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD BYCATEGORY','RECORD SALES',29,11,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD RAW BYTYPE','RECORD RAW SALES',30,12,'SUBFUNCTION','DATA');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('RECORD RAW BYCATEGORY','RECORD RAW SALES',31,12,'SUBFUNCTION','DATA');

--Register common code and testing
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('Question.viewQuestion()','VIEW QUESTIONNAIRE',1,1,'COMMON-CODE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('Question.fetchQuestion()','VIEW QUESTIONNAIRE',2,1,'COMMON-CODE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('Question.showListQuestion()','VIEW QUESTIONNAIRE',3,6,'COMMON-CODE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('Question.fetchQuestion()','VIEW QUESTIONNAIRE',4,6,'COMMON-CODE','WEB');
-- testing MULTIPLE FUNCTION insert with case
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('QUESTIONNAIRE KARYAWAN','WEB SALES FRONT',13,5,'FUNCTION','WEB');
-- testing SAME NAME IN DIFFERENT APPS
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('ABSENT KARYAWAN',NULL,3,NULL,'APPS','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('SM ABSENSI','ABSENT KARYAWAN',5,3,'MODULE','WEB');
INSERT INTO TREE_TABLE(NAME,PARENT_TO,CODE_FLAG,FLAG_BY,LVL_NAME,TYPE_USAGE) VALUES('QUESTIONNAIRE KARYAWAN','SM ABSENSI',9,5,'SUBMODULE','WEB');
COMMIT;

SELECT * FROM TREE_TABLE;

CREATE OR REPLACE TYPE COMMON_CODE_OBJ AS OBJECT(
    CODE_NAME VARCHAR2(50),
    PARAM_CONDITION VARCHAR2(60),
    CATEGORY VARCHAR2(20),
    TREE_ID NUMERIC
)

CREATE OR REPLACE PROCEDURE GET_FUNCTION_IN_APP(
    SUBFUNCTION_ID IN NUMERIC,
    I_COMMON_CODE IN COMMON_CODE_OBJ
)AS
BEGIN
    SELECT 
END;

SELECT * FROM TREE_TABLE;

SELECT T1.NAME,T1.LVL_NAME,T2.NAME
FROM TREE_TABLE T1
LEFT JOIN TREE_TABLE T2
ON T1.PARENT_TO=T2.NAME;

SELECT NAME,LVL_NAME, PRIOR NAME AS IS_CHILD_OF
FROM TREE_TABLE
START WITH PARENT_TO IS NULL
CONNECT BY PARENT_TO=PRIOR NAME;

SELECT NAME,LVL_NAME, PRIOR NAME AS IS_CHILD_OF
FROM TREE_TABLE
START WITH PARENT_TO='OKEFIT'
CONNECT BY PRIOR NAME=PARENT_TO

SELECT NAME,LVL_NAME, LEVEL
FROM TREE_TABLE
START WITH NAME='VIEW QUESTIONNAIRE'
CONNECT BY PRIOR PARENT_TO=NAME

--SELECT NAME||CODE_FLAG,LVL_NAME,PARENT_TO||FLAG_BY, LEVEL
--FROM TREE_TABLE
--START WITH NAME='WEB SEHAT BACK'
--CONNECT BY PRIOR PARENT_TO||1=NAME||CODE_FLAG

-- QUERY FIX, BUT STILL CAN'T SEPARATE BY LVL_NAME
-- THIS ONE SEARCH FROM ALL FIELADS
SELECT NAME,LVL_NAME,PARENT_TO, LEVEL,SYS_CONNECT_BY_PATH(NAME, '/') "Path"
FROM TREE_TABLE
START WITH NAME='Question.viewQuestion()'
CONNECT BY PRIOR PARENT_TO= NAME AND
        PRIOR FLAG_BY=CODE_FLAG
        
--QUERY SEPARATE BY LVL_NAME
SELECT NAME,LVL_NAME,PARENT_TO, LEVEL,SYS_CONNECT_BY_PATH(NAME, '/') "Path"
FROM TREE_TABLE
START WITH NAME='QUESTIONNAIRE KARYAWAN' AND LVL_NAME='FUNCTION'
CONNECT BY 
        PRIOR PARENT_TO= NAME AND
        PRIOR FLAG_BY=CODE_FLAG

--
SELECT NAME,LVL_NAME, PARENT_TO, LEVEL,SYS_CONNECT_BY_PATH(NAME, '/') "Path"
FROM TREE_TABLE
START WITH PARENT_TO='VIEW QUESTIONNAIRE'
CONNECT BY 
        PRIOR NAME= PARENT_TO AND
        PRIOR CODE_FLAG=FLAG_BY
        
--QUERY MULTIPLE PARAM
SELECT NAME,LVL_NAME,PARENT_TO,LEVEL,SYS_CONNECT_BY_PATH(NAME, '/') "Path" FROM(
    SELECT NAME,LVL_NAME,PARENT_TO, CODE_FLAG,FLAG_BY, LEVEL,SYS_CONNECT_BY_PATH(NAME, '/') "Path"
    FROM TREE_TABLE
    START WITH PARENT_TO ='WEB SEHAT BACK'
    CONNECT BY 
            PRIOR NAME= PARENT_TO AND
            PRIOR CODE_FLAG=FLAG_BY
)
START WITH PARENT_TO='VIEW QUESTIONNAIRE'
CONNECT BY 
        PRIOR NAME= PARENT_TO AND
        PRIOR CODE_FLAG=FLAG_BY

INSERT INTO TREE_DESC(PARAM_CONDITION,CATEGORY,SUBFUNCTION_ID,APP_ID) VALUES(NULL,'METHOD',27,1);
INSERT INTO TREE_DESC(PARAM_CONDITION,CATEGORY,SUBFUNCTION_ID,APP_ID) VALUES('int, List<customObject>','METHOD',27,1);
INSERT INTO TREE_DESC(PARAM_CONDITION,CATEGORY,SUBFUNCTION_ID,APP_ID) VALUES('String[], List<customObject>','METHOD',27,1);
INSERT INTO TREE_DESC(PARAM_CONDITION,CATEGORY,SUBFUNCTION_ID,APP_ID) VALUES('int, List<customObject>','METHOD',28,1);
COMMIT;